#!/sbin/sh
## Script by DAvinash97 @ xda-developers.com
## Huge Thanks to osm0sis for AnyKernel
## ui_print and few other methods are from AnyKernel
# Credits to askapache.com for online figlet generator
# link below
# https://www.askapache.com/online-tools/figlet-ascii/

OUTFD=/proc/self/fd/$2;
ZIPFILE="$3";
DEVICE=`getprop ro.product.device`;
BOOTDIR=`cat ../etc/recovery.fstab | grep 'boot' | awk '{printf$3}'`;

unzip $ZIPFILE;
ui_print() {
  until [ ! "$1" ]; do
    echo "ui_print $1
      ui_print" >> $OUTFD;
    shift;
  done;
}

ui_printfile() {
  while IFS='' read -r line || $BB [[ -n "$line" ]]; do
    ui_print "$line";
  done < $1;
}

show_progress() {
echo "progress $1 $2" >> $OUTFD;
}

file_getprop() {
$BB grep "^$2=" "$1" | $BB cut -d= -f2-;
}

finish() {
    if grep "vendor" /proc/mounts; then
        ui_print "mounting vendor";
        mount /vendor;
        cp -r /tmp/vendor ../vendor
    fi
    if [ -d data/magisk_backup* ]; then
       ui_print "Deleting Previous Magisk Backups"
       rm -rf data/magisk_backup*
    fi
    if [ -d /data/dalvik-cache ]; then
       ui_print "Wiping Dalvik-Cache"
       rm -rf /data/dalvik-cache
    fi

}

write_raw_image() {
  dd if=$1 of=$2;
}

ui_print " ";
ui_print "Written By DAvinash97 @xda-developers.com";
ui_print "Special Thanks to Osm0sis @xda-developers.com";
ui_print "For AnyKernel, as few codes are from there";
ui_print " ";

if [[ ! ` cat ../VARIANT | grep '[AGJ][3567][0123][01]'` ]]; then
	ui_print " ";
	ui_print "This Kernel is not for $DEVICE";
	ui_print "and is Not Supported";
	ui_print "aborting...";
	ui_printfile ../tmp/RIP;
	ui_print " ";
exit 1;
else
	ui_print "$DEVICE is Supported";
	ui_print " ";
	ui_printfile ../tmp/AEON;
	ui_print " ";
	ui_print "Your Kernel Directory is";
	ui_print "$BOOTDIR";
fi;

ui_print "Flashing Kernel";
write_raw_image boot.img $BOOTDIR

ui_print " ";
ui_print "Flashed"
finish
